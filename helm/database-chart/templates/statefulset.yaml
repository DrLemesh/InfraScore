apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "database-chart.fullname" . }}
  labels:
    {{- include "database-chart.labels" . | nindent 4 }}
spec:
  serviceName: {{ include "database-chart.fullname" . }}
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      serviceAccountName: {{ .Values.serviceAccount.name }}
      initContainers:
        - name: fetch-backup
          image: amazon/aws-cli:latest
          command:
            - "/bin/sh"
            - "-c"
            - |
              # Check if database is empty (first time setup)
              if [ ! -d "/var/lib/postgresql/data/pgdata/base" ]; then
                echo "Empty DB detected. Checking for backup in S3..."
                if aws s3 ls s3://{{ .Values.database.backupBucket }}/latest_backup.sql 2>/dev/null; then
                  echo "Backup found. Downloading to init directory..."
                  aws s3 cp s3://{{ .Values.database.backupBucket }}/latest_backup.sql /docker-entrypoint-initdb.d/restore.sql
                  echo "Backup downloaded successfully. PostgreSQL will restore on startup."
                else
                  echo "No backup found in S3. Starting with fresh database."
                fi
              else
                echo "Database already initialized. Skipping backup restore."
              fi
          volumeMounts:
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
      containers:
        - name: postgres
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: POSTGRES_USER
              value: "admin"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: password
            - name: POSTGRES_DB
              value: "quiz_project"
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          ports:
            - containerPort: 5432
              name: postgres
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      volumes:
        - name: init-scripts
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: {{ .Values.database.storage.class }}
        resources:
          requests:
            storage: {{ .Values.database.storage.size }}
